#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# Ensure root
[[ $EUID -eq 0 ]] && echo "Running as root..." || { echo "Run as root"; exit 1; }

# Base packages
pacman -Syu --needed --noconfirm \
  ttf-jetbrains-mono-nerd firefox fd ripgrep tree \
  nano-syntax-highlighting man-db wl-clipboard spectacle

# Pacman tweaks
sed -i "/\[multilib\]/,/Include/"'s/^#//' /etc/pacman.conf
sed -i 's|#Color|Color|' /etc/pacman.conf
sed -i 's|#VerbosePkgLists|VerbosePkgLists|' /etc/pacman.conf
sed -i 's|#ParallelDownloads = 5|ParallelDownloads = 10|' /etc/pacman.conf

# Mirrorlist
pacman -S --needed --noconfirm reflector
cat <<'EOF' >/etc/xdg/reflector/reflector.conf
--save /etc/pacman.d/mirrorlist
--protocol https
--latest 20
--age 12
--country IN,SG
--sort rate
--verbose
EOF
systemctl enable --now reflector.timer

# Firewall
pacman -S --needed --noconfirm ufw
systemctl enable --now ufw
ufw default deny incoming
ufw default allow outgoing
ufw --force enable

# NetworkManager config
cat <<'EOF' >/etc/NetworkManager/conf.d/custom.conf
[connection]
ipv6.ip6-privacy=2
[connection-mac-randomization]
ethernet.cloned-mac-address=random
wifi.cloned-mac-address=random
EOF

# Bluetooth
systemctl enable --now bluetooth

# Backlight
if ! grep -q "acpi_backlight=native" /etc/kernel/cmdline; then
  sed -i 's|$| acpi_backlight=native|' /etc/kernel/cmdline
  mkinitcpio -P
fi

# DNS-over-HTTPS
pacman -S --needed --noconfirm dns-over-https
systemctl enable --now doh-client
echo -e '[global-dns-domain-*]\nservers=127.0.0.1' \
  >/etc/NetworkManager/conf.d/dns-servers.conf
systemctl restart NetworkManager

# Fan control
paru -S --needed --noconfirm nbfc-linux
nbfc config --set auto || true
nbfc config --recommend || true
nbfc start || true
systemctl enable --now nbfc_service || true

# NVIDIA
pacman -S --needed --noconfirm nvidia-open
systemctl enable --now nvidia-resume nvidia-suspend nvidia-hibernate nvidia-powerd

# Intel + GPU
pacman -S --needed --noconfirm \
  intel-media-driver libva-nvidia-driver libvdpau-va-gl \
  vulkan-icd-loader vulkan-intel vulkan-mesa-layers

# EnvyControl
paru -S --needed --noconfirm envycontrol

# Wireless regdb
pacman -S --needed --noconfirm wireless-regdb
sed -i 's/^#WIRELESS_REGDOM=.*/WIRELESS_REGDOM="BO"/' /etc/conf.d/wireless-regdom

# Power profiles
pacman -S --needed --noconfirm power-profiles-daemon
systemctl enable --now power-profiles-daemon
